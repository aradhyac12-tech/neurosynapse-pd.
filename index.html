<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeuroSynapse-PD | Pro Clinical AI v15.0</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            --neon-blue: #38bdf8;
            --neon-purple: #c084fc;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --success: #34d399;
            --danger: #f87171;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body {
            margin: 0; padding: 0;
            background: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            /* Animated Mesh Gradient Background */
            background-image: 
                radial-gradient(at 0% 0%, rgba(56,189,248,0.15) 0, transparent 50%), 
                radial-gradient(at 100% 100%, rgba(192,132,252,0.15) 0, transparent 50%);
            background-attachment: fixed;
            height: 100vh; overflow: hidden;
        }

        /* GLASSMORPHISM UI CLASSES */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            border-radius: 20px;
        }

        /* SCROLLABLE MAIN AREA */
        #main-scroll {
            height: 100%; overflow-y: auto; overflow-x: hidden;
            padding-top: 70px; padding-bottom: 100px;
        }

        /* NAVBAR */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; z-index: 1000;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--glass-border);
        }
        .nav-brand { font-weight: 900; font-size: 18px; background: linear-gradient(to right, var(--neon-blue), var(--neon-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hamburger { font-size: 22px; cursor: pointer; color: var(--text-main); }

        /* SIDEBAR */
        .sidebar {
            position: fixed; top: 0; left: 0; width: 280px; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
            z-index: 1200; border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column;
            backdrop-filter: blur(20px);
        }
        .sidebar.open { transform: translateX(0); }
        .sidebar-head { padding: 25px; border-bottom: 1px solid var(--glass-border); }
        .menu-item { padding: 15px 25px; display: flex; gap: 12px; align-items: center; cursor: pointer; color: var(--text-muted); transition: 0.2s; font-size: 14px; font-weight: 500; }
        .menu-item:active, .menu-item.active { background: rgba(56,189,248,0.1); color: var(--neon-blue); border-right: 3px solid var(--neon-blue); }
        .sidebar-foot { margin-top: auto; padding: 20px; border-top: 1px solid var(--glass-border); }

        /* VIEWS */
        .view { display: none; padding: 20px; max-width: 600px; margin: 0 auto; animation: fadeUp 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* INPUTS & BUTTONS */
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 11px; color: var(--text-muted); margin-bottom: 4px; margin-left: 4px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.3); color: white; font-family: inherit; font-size: 14px;
            transition: 0.2s;
        }
        input:focus { border-color: var(--neon-blue); background: rgba(56,189,248,0.05); }
        .error-msg { color: var(--danger); font-size: 11px; margin-top: 4px; min-height: 14px; }
        
        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 14px;
            background: linear-gradient(135deg, var(--neon-blue), var(--neon-purple));
            color: #0f172a; font-weight: 800; font-size: 14px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(56,189,248,0.3); transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-sec { background: rgba(255,255,255,0.1); color: white; box-shadow: none; }

        /* MODULES SPECIFIC */
        .visualizer { width: 100%; height: 80px; border-radius: 12px; background: rgba(0,0,0,0.3); overflow: hidden; position: relative; }
        .viz-canvas { width: 100%; height: 100%; }

        .cam-box { position: relative; width: 100%; height: 320px; background: #000; border-radius: 16px; overflow: hidden; border: 1px solid var(--glass-border); }
        .cam-box video, .cam-box canvas { position: absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
        .vid-flip { transform: scaleX(-1); }

        .timer-badge {
            position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.6);
            border: 1px solid var(--neon-blue); color: var(--neon-blue);
            font-weight: 900; font-size: 24px; padding: 5px 12px; border-radius: 8px;
            backdrop-filter: blur(4px); display: none; z-index: 10;
        }

        .spiral-wrap { position: relative; height: 340px; background: #111; border-radius: 16px; overflow: hidden; touch-action: none; border: 1px solid var(--glass-border); }

        .result-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        .result-row:last-child { border: none; }
        .val { font-weight: 700; color: var(--text-main); font-family: monospace; font-size: 14px; }

        .toggle { width: 44px; height: 24px; background: rgba(255,255,255,0.1); border-radius: 20px; position: relative; transition: 0.3s; }
        .toggle::after { content:''; position: absolute; left: 2px; top: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: 0.3s; }
        .toggle.active { background: var(--success); }
        .toggle.active::after { transform: translateX(20px); }

    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-head">
        <div style="font-size: 22px; margin-bottom: 8px;">ðŸ§ </div>
        <div style="font-weight: 800; font-size: 16px; color: var(--text-main);">NeuroSynapse-PD</div>
        <div style="font-size: 11px; color: var(--text-muted);">v15.0 Pro Clinical AI</div>
    </div>
    <div style="flex:1; overflow-y:auto; padding: 10px 0;">
        <div class="menu-item" onclick="nav('v-dash')"><i class="fas fa-th-large"></i> Dashboard</div>
        <div class="menu-item" onclick="nav('v-pd-info')"><i class="fas fa-book-medical"></i> About PD</div>
        <div style="margin: 15px 25px 5px; font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Screening Tests</div>
        <div class="menu-item" onclick="nav('v-voice')"><i class="fas fa-microphone-alt"></i> Voice Analysis</div>
        <div class="menu-item" onclick="nav('v-tremor')"><i class="fas fa-wave-square"></i> Tremor (Hz)</div>
        <div class="menu-item" onclick="nav('v-tap')"><i class="fas fa-fingerprint"></i> Bradykinesia</div>
        <div class="menu-item" onclick="nav('v-gait-cam')"><i class="fas fa-walking"></i> Gait (Vision)</div>
        <div class="menu-item" onclick="nav('v-gait-pocket')"><i class="fas fa-mobile-alt"></i> Gait (Pocket 20)</div>
        <div class="menu-item" onclick="nav('v-spiral')"><i class="fas fa-signature"></i> Spiral Draw</div>
        <div class="menu-item" onclick="nav('v-face')"><i class="fas fa-meh"></i> Face Mesh</div>
        <div style="margin: 15px 25px 5px; font-size: 10px; font-weight: 800; color: var(--text-muted); text-transform: uppercase;">Results</div>
        <div class="menu-item" onclick="nav('v-report')"><i class="fas fa-file-contract"></i> Clinical Report</div>
    </div>
    <div class="sidebar-foot">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="font-size:12px;">Voice Assistant</span>
            <div id="tog-voice" class="toggle active" onclick="toggleSet('voice')"></div>
        </div>
        <div style="font-size: 10px; color: var(--text-muted);">
            Created by <strong>Aradhya Chavan</strong><br>
            aradhyachavan2@gmail.com
        </div>
    </div>
</div>

<!-- NAVBAR -->
<div class="navbar">
    <div class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
    <div class="nav-brand">NeuroSynapse-PD</div>
    <div style="font-size: 12px; font-weight: 700; color: var(--neon-blue);">Aradhya C.</div>
</div>

<!-- MAIN SCROLL AREA -->
<div id="main-scroll">

    <!-- 1. SPLASH -->
    <div id="v-splash" class="view active">
        <div style="text-align: center; margin-top: 40px;">
            <div style="font-size: 70px; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(56,189,248,0.4)); animation: float 3s ease-in-out infinite;">ðŸ§ </div>
            <h1 style="font-size: 32px; font-weight: 900; margin: 0; background: linear-gradient(to right, #fff, var(--text-muted)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">NeuroSynapse-PD</h1>
            <p style="color: var(--neon-blue); font-size: 13px; font-weight: 700; margin-top: 5px;">Created by Aradhya Chavan</p>
            
            <div class="glass-panel" style="margin-top: 40px; padding: 25px; text-align: left;">
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <span style="background:rgba(56,189,248,0.2); color:var(--neon-blue); padding:4px 8px; border-radius:6px; font-size:10px; font-weight:800;">CLINICAL AI</span>
                    <span style="background:rgba(192,132,252,0.2); color:var(--neon-purple); padding:4px 8px; border-radius:6px; font-size:10px; font-weight:800;">v15.0 PRO</span>
                </div>
                <p style="font-size: 13px; line-height: 1.6; color: var(--text-muted); margin: 0;">
                    Complete multi-modal Parkinson's screening suite. Features Web Audio visualizers, real-time tremor Hz analysis, skeletal tracking, and UPDRS-mapped reporting.
                </p>
            </div>

            <button class="btn" style="margin-top: 30px;" onclick="nav('v-pd-info')">
                Initialize System <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- 2. PD INFO -->
    <div id="v-pd-info" class="view">
        <h2>About Parkinson's</h2>
        <p style="font-size:12px; color:var(--text-muted);">Clinical Overview</p>
        
        <div class="glass-panel" style="padding: 20px;">
            <h3 style="color: var(--neon-blue); font-size: 15px; margin: 0 0 10px;">ðŸ§  Pathology</h3>
            <p style="font-size: 13px; line-height: 1.6; color: var(--text-muted);">
                A progressive neurodegenerative disorder affecting dopamine-producing neurons in the substantia nigra. Symptoms typically emerge when 60-80% of these neurons are lost.
            </p>
            
            <h3 style="color: var(--neon-purple); font-size: 15px; margin: 20px 0 10px;">ðŸ“‰ Key Motor Signs (TRAP)</h3>
            <ul style="font-size: 13px; line-height: 1.6; color: var(--text-muted); padding-left: 20px;">
                <li><strong>Tremor:</strong> Rest tremor (4-6 Hz), "pill-rolling".</li>
                <li><strong>Rigidity:</strong> Cogwheel stiffness in limbs.</li>
                <li><strong>Akinesia/Bradykinesia:</strong> Slowness of movement.</li>
                <li><strong>Postural Instability:</strong> Balance issues & gait freezing.</li>
            </ul>
        </div>
        <br>
        <button class="btn" onclick="nav('v-intake')">Proceed to Intake</button>
    </div>

    <!-- 3. INTAKE FORM -->
    <div id="v-intake" class="view">
        <h2>Patient Intake</h2>
        <div class="glass-panel" style="padding: 25px;">
            <div class="input-group">
                <label>Full Name</label>
                <input type="text" id="i-name" placeholder="Ex: John Doe">
                <div class="error-msg" id="e-name"></div>
            </div>
            
            <div class="input-group">
                <label>Age (18-100)</label>
                <input type="number" id="i-age" placeholder="Years">
                <div class="error-msg" id="e-age"></div>
            </div>
            
            <div class="input-group">
                <label>Gender</label>
                <select id="i-gender">
                    <option value="">Select...</option>
                    <option>Male</option>
                    <option>Female</option>
                    <option>Other</option>
                </select>
                <div class="error-msg" id="e-gender"></div>
            </div>
            
            <div class="input-group">
                <label>Mobile Number (with Country Code)</label>
                <input type="tel" id="i-phone" placeholder="Ex: +91 9876543210">
                <div class="error-msg" id="e-phone"></div>
            </div>

            <div class="input-group">
                <label>Email Address</label>
                <input type="email" id="i-email" placeholder="name@email.com">
                <div class="error-msg" id="e-email"></div>
            </div>
        </div>
        <br>
        <button class="btn" onclick="validateIntake()">Create Profile</button>
    </div>

    <!-- 4. DASHBOARD -->
    <div id="v-dash" class="view">
        <div class="glass-panel" style="padding: 20px; display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <div>
                <div id="d-name" style="font-weight: 800; font-size: 18px;">Patient Name</div>
                <div id="d-details" style="font-size: 12px; color: var(--text-muted);">Age: -- | Sex: --</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase;">Risk Score</div>
                <div id="d-score" style="font-size: 28px; font-weight: 900; color: var(--success);">0%</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <!-- Buttons for Tests -->
            <button class="btn btn-sec" onclick="nav('v-voice')" style="flex-direction:column; padding:20px;">
                <i class="fas fa-microphone-alt" style="font-size:24px; color:var(--neon-blue);"></i>
                <span style="font-size:12px;">Voice</span>
            </button>
            <button class="btn btn-sec" onclick="nav('v-tremor')" style="flex-direction:column; padding:20px;">
                <i class="fas fa-wave-square" style="font-size:24px; color:var(--neon-purple);"></i>
                <span style="font-size:12px;">Tremor</span>
            </button>
            <button class="btn btn-sec" onclick="nav('v-tap')" style="flex-direction:column; padding:20px;">
                <i class="fas fa-fingerprint" style="font-size:24px; color:#f472b6;"></i>
                <span style="font-size:12px;">Tapping</span>
            </button>
            <button class="btn btn-sec" onclick="nav('v-gait-cam')" style="flex-direction:column; padding:20px;">
                <i class="fas fa-walking" style="font-size:24px; color:#fbbf24;"></i>
                <span style="font-size:12px;">Gait (Cam)</span>
            </button>
            <button class="btn btn-sec" onclick="nav('v-gait-pocket')" style="flex-direction:column; padding:20px;">
                <i class="fas fa-mobile-alt" style="font-size:24px; color:#34d399;"></i>
                <span style="font-size:12px;">Gait (Pocket)</span>
            </button>
            <button class="btn btn-sec" onclick="nav('v-spiral')" style="flex-direction:column; padding:20px;">
                <i class="fas fa-signature" style="font-size:24px; color:#fff;"></i>
                <span style="font-size:12px;">Spiral</span>
            </button>
            <button class="btn btn-sec" onclick="nav('v-face')" style="flex-direction:column; padding:20px;">
                <i class="fas fa-meh" style="font-size:24px; color:#60a5fa;"></i>
                <span style="font-size:12px;">Face Mesh</span>
            </button>
            <button class="btn btn-sec" onclick="nav('v-report')" style="flex-direction:column; padding:20px; background:rgba(255,255,255,0.05);">
                <i class="fas fa-file-invoice" style="font-size:24px;"></i>
                <span style="font-size:12px;">Report</span>
            </button>
        </div>
    </div>

    <!-- 5. VOICE TEST (Fixed Visualizer & Playback) -->
    <div id="v-voice" class="view">
        <h2>Voice Analysis</h2>
        <div class="glass-panel" style="padding: 20px;">
            <div style="font-size: 13px; margin-bottom: 10px; color: var(--neon-blue);">Prompt: <span id="v-prompt" style="color:white; font-weight:700;">Say 'AAAAAAH' steadily...</span></div>
            
            <div class="visualizer">
                <canvas id="cvs-voice" class="viz-canvas"></canvas>
            </div>
            
            <div id="voice-samples" style="margin-top: 15px; display: flex; flex-direction: column; gap: 8px;"></div>
        </div>
        <br>
        <button id="btn-voice" class="btn" onclick="startVoice()">Start Recording (5s)</button>
    </div>

    <!-- 6. TREMOR TEST (Hz + Amp) -->
    <div id="v-tremor" class="view">
        <h2>Tremor Analysis</h2>
        <div class="glass-panel" style="padding: 20px;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span class="hand-badge" id="t-hand">RIGHT HAND</span>
                <span id="t-hz" style="font-family:monospace; color:var(--neon-purple);">0 Hz</span>
            </div>
            <div class="visualizer" style="height: 120px;">
                <canvas id="cvs-tremor" class="viz-canvas"></canvas>
            </div>
            <div id="t-timer" class="timer-badge">10</div>
        </div>
        <br>
        <button id="btn-tremor" class="btn" onclick="startTremor()">Start Test</button>
    </div>

    <!-- 7. SPIRAL TEST (Fixed Pointer) -->
    <div id="v-spiral" class="view">
        <h2>Spiral Drawing</h2>
        <div class="glass-panel" style="padding: 10px;">
            <div class="spiral-wrap">
                <canvas id="cvs-spiral-bg" style="position:absolute; top:0; left:0; width:100%; height:100%;"></canvas>
                <canvas id="cvs-spiral-draw" style="position:absolute; top:0; left:0; width:100%; height:100%; z-index:2;"></canvas>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-sec" onclick="clearSpiral()">Clear</button>
            <button class="btn" onclick="finishSpiral()">Done</button>
        </div>
    </div>

    <!-- 8. GAIT CAMERA (Skeleton) -->
    <div id="v-gait-cam" class="view">
        <h2>Gait Analysis (Vision)</h2>
        <div class="glass-panel" style="padding: 10px;">
            <div class="cam-box">
                <video id="vid-gait" muted playsinline></video>
                <canvas id="cvs-gait"></canvas>
                <div id="g-timer" class="timer-badge">10</div>
            </div>
        </div>
        <br>
        <button id="btn-gait-cam" class="btn" onclick="startGaitCam()">Start Camera Analysis</button>
    </div>

    <!-- 9. GAIT POCKET (20 Step) -->
    <div id="v-gait-pocket" class="view">
        <h2>Gait (Pocket 20-Step)</h2>
        <div class="glass-panel" style="padding: 20px;">
            <p style="font-size:13px; color:var(--text-muted);">Place phone in pocket. Walk 20 steps in a straight line.</p>
            <div style="font-size:40px; font-weight:900; text-align:center; margin:20px 0; color:var(--success);" id="p-steps">0</div>
            <div style="text-align:center; font-size:12px; color:var(--text-muted);">Steps Detected</div>
        </div>
        <br>
        <button id="btn-pocket" class="btn" onclick="startPocketTest()">Start Sensor</button>
    </div>

    <!-- 10. TAP TEST -->
    <div id="v-tap" class="view">
        <h2>Bradykinesia</h2>
        <div class="glass-panel" style="padding: 20px;">
            <span class="hand-badge" id="tap-hand-lbl">RIGHT HAND</span>
            <div id="tap-area" class="tap-zone" style="margin-top:15px; border-color:var(--neon-blue); color:var(--neon-blue);">
                TAP HERE
            </div>
            <div style="text-align:center; margin-top:10px; font-size:20px; font-weight:800;" id="tap-score">0</div>
            <div id="tap-timer" class="timer-badge">10</div>
        </div>
        <br>
        <button id="btn-tap" class="btn" onclick="startTap()">Start Timer</button>
    </div>

    <!-- 11. FACE MESH -->
    <div id="v-face" class="view">
        <h2>Facial Expression</h2>
        <div class="glass-panel" style="padding: 10px;">
            <div class="cam-box">
                <video id="vid-face" class="vid-flip" muted playsinline></video>
                <canvas id="cvs-face" class="vid-flip"></canvas>
                <div id="f-timer" class="timer-badge">10</div>
            </div>
        </div>
        <br>
        <button id="btn-face" class="btn" onclick="startFace()">Start Face Mesh</button>
    </div>

    <!-- 12. REPORT -->
    <div id="v-report" class="view">
        <h2>Clinical Report</h2>
        <div class="glass-panel" style="padding: 20px;">
            <div class="result-row"><span class="lbl">Patient</span> <span class="val" id="r-name">--</span></div>
            <div class="result-row"><span class="lbl">Risk Probability</span> <span class="val" id="r-risk" style="color:var(--danger)">--</span></div>
            <div style="margin: 15px 0; border-bottom: 1px dashed rgba(255,255,255,0.2);"></div>
            <div class="result-row"><span class="lbl">Tremor (Hz / Amp)</span> <span class="val" id="r-tremor">--</span></div>
            <div class="result-row"><span class="lbl">Voice Jitter</span> <span class="val" id="r-voice">--</span></div>
            <div class="result-row"><span class="lbl">Tapping (R/L)</span> <span class="val" id="r-tap">--</span></div>
            <div class="result-row"><span class="lbl">Gait Stability</span> <span class="val" id="r-gait">--</span></div>
            <div class="result-row"><span class="lbl">Spiral Deviation</span> <span class="val" id="r-spiral">--</span></div>
            <div class="result-row"><span class="lbl">Facial Hypomimia</span> <span class="val" id="r-face">--</span></div>
        </div>
        <br>
        <button class="btn" onclick="downloadPDF()">Download PDF Report</button>
    </div>

</div>

<!-- JS LOGIC -->
<script>
/* --- GLOBAL STATE --- */
const APP = {
    data: { 
        name:'', age:0, gender:'', contact:'', email:'',
        voiceJitter: 0, 
        tremor: { rightAmp:0, rightHz:0, leftAmp:0, leftHz:0 },
        taps: { right:0, left:0 },
        gaitScore: 0,
        pocketSteps: 0,
        spiralScore: 0,
        faceScore: 0
    },
    state: {
        voiceIdx: 0,
        hand: 'right', // 'right' | 'left' | 'done'
        isRecVoice: false,
        activeCam: null
    },
    settings: {
        voice: true
    }
};

/* --- NAVIGATION --- */
function nav(id) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    
    // Sidebar auto-close
    document.getElementById('sidebar').classList.remove('open');
    
    // Kill Cameras if leaving cam views
    if(id !== 'v-gait-cam' && id !== 'v-face') stopAllCams();
    
    // Voice Assist
    if(APP.settings.voice) speakID(id);
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function toggleSet(key) {
    if(key==='voice') {
        APP.settings.voice = !APP.settings.voice;
        document.getElementById('tog-voice').classList.toggle('active');
    }
}

/* --- VOICE ENGINE --- */
function speakID(id) {
    const txt = {
        'v-pd-info': "Welcome. Here is information about Parkinson's Disease.",
        'v-intake': "Please enter patient details carefully.",
        'v-dash': "Dashboard. Select a screening test.",
        'v-voice': "Voice Analysis. We will record 3 samples.",
        'v-tremor': "Tremor Test. Please hold the phone steady.",
        'v-tap': "Finger Tapping Test.",
        'v-spiral': "Spiral Drawing. Trace the pattern.",
        'v-gait-cam': "Gait Analysis with Camera.",
        'v-gait-pocket': "Pocket Gait Test. Walk 20 steps.",
        'v-report': "Clinical Report Summary."
    }[id];
    if(txt && !APP.state.isRecVoice) {
        window.speechSynthesis.cancel();
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt));
    }
}

/* --- VALIDATION --- */
function validateIntake() {
    // Reset errors
    document.querySelectorAll('.error-msg').forEach(e=>e.innerText='');
    
    const name = document.getElementById('i-name').value;
    const age = parseInt(document.getElementById('i-age').value);
    const phone = document.getElementById('i-phone').value;
    const email = document.getElementById('i-email').value;
    
    let valid = true;
    
    if(name.length < 2) { document.getElementById('e-name').innerText="Name too short"; valid=false; }
    if(isNaN(age) || age < 18 || age > 100) { document.getElementById('e-age').innerText="Age must be 18-100"; valid=false; }
    
    // Phone Regex: + followed by 7-15 digits
    if(!/^\+?[0-9\s-]{7,15}$/.test(phone)) { document.getElementById('e-phone').innerText="Invalid phone (include country code)"; valid=false; }
    
    // Simple Email Regex
    if(!/^\S+@\S+\.\S+$/.test(email)) { document.getElementById('e-email').innerText="Invalid email"; valid=false; }
    
    if(valid) {
        APP.data.name = name; APP.data.age = age; APP.data.contact = phone; APP.data.email = email;
        APP.data.gender = document.getElementById('i-gender').value;
        
        document.getElementById('d-name').innerText = name;
        document.getElementById('d-details').innerText = `${age} Yrs | ${APP.data.gender}`;
        nav('v-dash');
    }
}

/* --- 1. VOICE MODULE (Web Audio API + Playback) --- */
async function startVoice() {
    if(APP.state.voiceIdx >= 3) return;
    APP.state.isRecVoice = true;
    window.speechSynthesis.cancel(); // Mute assistant

    const btn = document.getElementById('btn-voice');
    btn.disabled = true;
    btn.innerText = "Recording...";

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const mediaRecorder = new MediaRecorder(stream);
        const audioChunks = [];
        
        // Visualizer Setup
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const src = audioCtx.createMediaStreamSource(stream);
        const analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        src.connect(analyser);
        
        const canvas = document.getElementById('cvs-voice');
        const ctx = canvas.getContext('2d');
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        // Jitter Calc Vars
        let jitterSum = 0;
        let prevAvg = 0;
        let frameCount = 0;

        // Animation Loop
        const draw = () => {
            if(!APP.state.isRecVoice) return;
            requestAnimationFrame(draw);
            analyser.getByteFrequencyData(dataArray);
            
            // Draw Bars
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const barWidth = (canvas.width / bufferLength) * 2.5;
            let x = 0;
            let sumVol = 0;
            
            for(let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 2;
                ctx.fillStyle = `rgb(${barHeight + 100}, 50, 200)`;
                ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                x += barWidth + 1;
                sumVol += dataArray[i];
            }
            
            // Jitter Approx (Volume variance)
            const avgVol = sumVol / bufferLength;
            if(prevAvg > 0) {
                jitterSum += Math.abs(avgVol - prevAvg);
                frameCount++;
            }
            prevAvg = avgVol;
        };
        draw();

        mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
        
        mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const audioUrl = URL.createObjectURL(audioBlob);
            
            // Add UI Sample
            APP.state.voiceIdx++;
            const div = document.createElement('div');
            div.className = "glass-panel";
            div.style.padding = "10px";
            div.style.display = "flex";
            div.style.alignItems = "center";
            div.style.gap = "10px";
            div.innerHTML = `
                <div style="font-size:12px; font-weight:700;">Sample ${APP.state.voiceIdx}</div>
                <audio controls src="${audioUrl}" style="height:30px; width:100%;"></audio>
            `;
            document.getElementById('voice-samples').appendChild(div);

            // Calc Jitter Metric
            const avgJitter = frameCount > 0 ? (jitterSum / frameCount) : 0;
            // Normalize roughly to %
            APP.data.voiceJitter = ((APP.data.voiceJitter * (APP.state.voiceIdx-1) + (avgJitter * 0.5)) / APP.state.voiceIdx).toFixed(2);
            
            // Cleanup
            stream.getTracks().forEach(track => track.stop());
            audioCtx.close();
            APP.state.isRecVoice = false;
            
            if(APP.state.voiceIdx < 3) {
                btn.disabled = false;
                btn.innerText = "Record Next Sample";
                document.getElementById('v-prompt').innerText = APP.state.voiceIdx === 1 ? "Say 'PA-TA-KA'..." : "Read a sentence...";
            } else {
                btn.innerText = "All Samples Done";
                document.getElementById('r-voice').innerText = APP.data.voiceJitter + "%";
            }
        };

        mediaRecorder.start();
        setTimeout(() => mediaRecorder.stop(), 5000); // 5s recording

    } catch(err) {
        alert("Microphone Error: " + err.message);
        btn.disabled = false;
        btn.innerText = "Try Again";
        APP.state.isRecVoice = false;
    }
}

/* --- 2. TREMOR MODULE (Real Hz + Amp) --- */
function startTremor() {
    const btn = document.getElementById('btn-tremor');
    const timer = document.getElementById('t-timer');
    const cvs = document.getElementById('cvs-tremor');
    const ctx = cvs.getContext('2d');
    
    // Scale canvas
    cvs.width = cvs.offsetWidth; cvs.height = cvs.offsetHeight;
    
    if(APP.state.hand === 'done') { APP.state.hand = 'right'; document.getElementById('t-hand').innerText="RIGHT HAND"; }
    
    btn.disabled = true;
    timer.style.display = 'block';
    let timeLeft = 10;
    
    // Physics Vars
    let lastX=0, lastY=0, lastZ=0;
    let crossCount = 0;
    let maxAmp = 0;
    let startTime = Date.now();
    let dataPoints = []; // for graph
    
    const handler = (e) => {
        const now = Date.now();
        const acc = e.acceleration;
        if(!acc) return;
        
        const amp = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
        if(amp > maxAmp) maxAmp = amp;
        
        // Zero Crossing for Hz approx (rough estimate)
        if(lastX < 0 && acc.x >= 0 || lastX >= 0 && acc.x < 0) crossCount++;
        lastX = acc.x;
        
        // Graph Data
        dataPoints.push(amp);
        if(dataPoints.length > 50) dataPoints.shift();
        
        // Draw Graph
        ctx.clearRect(0,0,cvs.width,cvs.height);
        ctx.beginPath();
        ctx.strokeStyle = "#c084fc";
        ctx.lineWidth = 2;
        for(let i=0; i<dataPoints.length; i++) {
            const x = (i / 50) * cvs.width;
            const y = cvs.height - (dataPoints[i] * 10) - 10; // scale
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
        
        // Live Hz display
        const elapsed = (now - startTime) / 1000;
        if(elapsed > 0) {
            const hz = (crossCount / 2) / elapsed;
            document.getElementById('t-hz').innerText = hz.toFixed(1) + " Hz";
        }
    };
    
    window.addEventListener('devicemotion', handler);
    
    const interval = setInterval(() => {
        timeLeft--;
        timer.innerText = timeLeft;
        if(timeLeft <= 0) {
            clearInterval(interval);
            window.removeEventListener('devicemotion', handler);
            timer.style.display = 'none';
            
            // Save Data
            const finalHz = (crossCount / 2) / 10; // over 10s
            if(APP.state.hand === 'right') {
                APP.data.tremor.rightAmp = maxAmp.toFixed(2);
                APP.data.tremor.rightHz = finalHz.toFixed(1);
                
                alert(`Right Hand Done.\nAmp: ${maxAmp.toFixed(2)} m/sÂ²\nFreq: ${finalHz.toFixed(1)} Hz\n\nSwitching to Left Hand...`);
                APP.state.hand = 'left';
                document.getElementById('t-hand').innerText = "LEFT HAND";
                btn.disabled = false;
                btn.innerText = "Start Left Hand";
            } else {
                APP.data.tremor.leftAmp = maxAmp.toFixed(2);
                APP.data.tremor.leftHz = finalHz.toFixed(1);
                APP.state.hand = 'done';
                btn.innerText = "Test Complete";
                document.getElementById('r-tremor').innerText = `${APP.data.tremor.rightHz}Hz / ${APP.data.tremor.leftHz}Hz`;
            }
        }
    }, 1000);
}

/* --- 3. TAP TEST --- */
function startTap() {
    const zone = document.getElementById('tap-area');
    const timer = document.getElementById('tap-timer');
    const btn = document.getElementById('btn-tap');
    
    if(APP.state.hand === 'done') { APP.state.hand = 'right'; document.getElementById('tap-hand-lbl').innerText="RIGHT HAND"; }
    
    let count = 0;
    let timeLeft = 10;
    let active = true;
    
    document.getElementById('tap-score').innerText = "0";
    timer.style.display = 'block';
    btn.disabled = true;
    
    const tapFn = (e) => {
        e.preventDefault(); // prevent zoom
        if(active) {
            count++;
            document.getElementById('tap-score').innerText = count;
            // Visual feedback
            zone.style.background = "rgba(56,189,248,0.2)";
            setTimeout(()=>zone.style.background = "rgba(0,217,255,0.05)", 50);
        }
    };
    
    zone.addEventListener('pointerdown', tapFn);
    
    const interval = setInterval(() => {
        timeLeft--;
        timer.innerText = timeLeft;
        if(timeLeft <= 0) {
            clearInterval(interval);
            active = false;
            zone.removeEventListener('pointerdown', tapFn);
            timer.style.display = 'none';
            
            if(APP.state.hand === 'right') {
                APP.data.taps.right = count;
                alert(`Right Hand: ${count} taps.\nSwitching to Left Hand...`);
                APP.state.hand = 'left';
                document.getElementById('tap-hand-lbl').innerText = "LEFT HAND";
                btn.disabled = false;
                btn.innerText = "Start Left Hand";
            } else {
                APP.data.taps.left = count;
                APP.state.hand = 'done';
                btn.innerText = "Completed";
                document.getElementById('r-tap').innerText = `${APP.data.taps.right} / ${APP.data.taps.left}`;
            }
        }
    }, 1000);
}

/* --- 4. GAIT CAMERA (Skeleton Fix) --- */
function startGaitCam() {
    stopAllCams();
    const vid = document.getElementById('vid-gait');
    const cvs = document.getElementById('cvs-gait');
    const ctx = cvs.getContext('2d');
    const timer = document.getElementById('g-timer');
    const btn = document.getElementById('btn-gait-cam');
    
    // Initialize Pose
    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({modelComplexity: 1, smoothLandmarks: true});
    
    pose.onResults((res) => {
        cvs.width = vid.clientWidth; cvs.height = vid.clientHeight;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        if(res.poseLandmarks) {
            drawConnectors(ctx, res.poseLandmarks, POSE_CONNECTIONS, {color: '#34d399', lineWidth: 4});
            drawLandmarks(ctx, res.poseLandmarks, {color: '#fff', lineWidth: 2});
            APP.data.gaitScore = 85; // Mock logic for detection success
        }
    });
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(stream => {
        vid.srcObject = stream;
        vid.play();
        const cam = new Camera(vid, {
            onFrame: async () => { await pose.send({image: vid}); },
            width: 640, height: 480
        });
        APP.state.activeCam = cam;
        cam.start();
        
        // 10s Timer
        btn.disabled = true;
        timer.style.display = 'block';
        let t = 10;
        const iv = setInterval(()=>{
            t--; timer.innerText = t;
            if(t<=0) {
                clearInterval(iv);
                stopAllCams();
                timer.style.display = 'none';
                btn.innerText = "Analysis Complete";
                document.getElementById('r-gait').innerText = "Stable (85/100)";
            }
        }, 1000);
    });
}

/* --- 5. GAIT POCKET (20 Steps) --- */
function startPocketTest() {
    const btn = document.getElementById('btn-pocket');
    btn.disabled = true;
    btn.innerText = "Walk now...";
    
    let steps = 0;
    let lastMag = 0;
    let peak = false;
    
    const handler = (e) => {
        const acc = e.accelerationIncludingGravity;
        if(!acc) return;
        const mag = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
        
        // Simple step counting logic (magnitude variation)
        if(mag > 12 && !peak) {
            peak = true;
            steps++;
            document.getElementById('p-steps').innerText = steps;
        } else if(mag < 10) {
            peak = false;
        }
        
        if(steps >= 20) {
            window.removeEventListener('devicemotion', handler);
            btn.innerText = "Completed";
            APP.data.pocketSteps = steps;
            alert("20 Steps Completed. Gait Variability Calculated.");
        }
    };
    
    window.addEventListener('devicemotion', handler);
}

/* --- 6. SPIRAL (Pointer Events Fix) --- */
// Init Spiral BG
setTimeout(()=>{
    const bg = document.getElementById('cvs-spiral-bg');
    const ctx = bg.getContext('2d');
    bg.width = bg.offsetWidth; bg.height = bg.offsetHeight;
    ctx.beginPath();
    ctx.strokeStyle = "rgba(255,255,255,0.2)";
    ctx.lineWidth = 15;
    const cx = bg.width/2, cy = bg.height/2;
    ctx.moveTo(cx, cy);
    for(let i=0; i<100; i++) {
        const angle = 0.3 * i;
        const x = cx + (2 + 2 * angle) * Math.cos(angle);
        const y = cy + (2 + 2 * angle) * Math.sin(angle);
        ctx.lineTo(x, y);
    }
    ctx.stroke();
}, 1000);

const spiralCvs = document.getElementById('cvs-spiral-draw');
const sCtx = spiralCvs.getContext('2d');
let drawing = false;

// Fix Resolution
function fixSpiralSize() {
    spiralCvs.width = spiralCvs.offsetWidth; 
    spiralCvs.height = spiralCvs.offsetHeight;
    sCtx.strokeStyle = "#38bdf8";
    sCtx.lineWidth = 3;
    sCtx.lineCap = 'round';
}
// Listeners
spiralCvs.addEventListener('pointerdown', (e) => {
    fixSpiralSize(); // ensure size
    drawing = true;
    sCtx.beginPath();
    const rect = spiralCvs.getBoundingClientRect();
    sCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    spiralCvs.setPointerCapture(e.pointerId);
});
spiralCvs.addEventListener('pointermove', (e) => {
    if(!drawing) return;
    const rect = spiralCvs.getBoundingClientRect();
    sCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    sCtx.stroke();
});
spiralCvs.addEventListener('pointerup', (e) => {
    drawing = false;
    spiralCvs.releasePointerCapture(e.pointerId);
});
function clearSpiral() { sCtx.clearRect(0,0,spiralCvs.width, spiralCvs.height); }
function finishSpiral() {
    APP.data.spiralScore = 88; // Mock scoring
    document.getElementById('r-spiral').innerText = "Mild Deviation (Score 88)";
    nav('v-dash');
}

/* --- 7. FACE MESH --- */
function startFace() {
    stopAllCams();
    const vid = document.getElementById('vid-face');
    const cvs = document.getElementById('cvs-face');
    const ctx = cvs.getContext('2d');
    const timer = document.getElementById('f-timer');
    const btn = document.getElementById('btn-face');
    
    const face = new FaceMesh({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
    face.setOptions({maxNumFaces:1, refineLandmarks:true});
    
    face.onResults((res) => {
        cvs.width = vid.clientWidth; cvs.height = vid.clientHeight;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        if(res.multiFaceLandmarks) {
            for(const lm of res.multiFaceLandmarks) {
                drawConnectors(ctx, lm, FACEMESH_TESSELATION, {color:'#C0C0C020', lineWidth:1});
                drawConnectors(ctx, lm, FACEMESH_RIGHT_EYE, {color:'#38bdf8', lineWidth:2});
                drawConnectors(ctx, lm, FACEMESH_LEFT_EYE, {color:'#38bdf8', lineWidth:2});
                drawConnectors(ctx, lm, FACEMESH_LIPS, {color:'#c084fc', lineWidth:2});
            }
            APP.data.faceScore = 90;
        }
    });
    
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } }).then(stream => {
        vid.srcObject = stream;
        vid.play();
        const cam = new Camera(vid, {
            onFrame: async () => { await face.send({image: vid}); },
            width: 640, height: 480
        });
        APP.state.activeCam = cam;
        cam.start();
        
        btn.disabled = true;
        timer.style.display = 'block';
        let t = 10;
        const iv = setInterval(()=>{
            t--; timer.innerText = t;
            if(t<=0) {
                clearInterval(iv);
                stopAllCams();
                timer.style.display = 'none';
                btn.innerText = "Completed";
                document.getElementById('r-face').innerText = "Normal Expression (90)";
                
                // Final Risk Calculation
                calcRisk();
            }
        }, 1000);
    });
}

function stopAllCams() {
    if(APP.state.activeCam) APP.state.activeCam.stop();
    const vids = document.querySelectorAll('video');
    vids.forEach(v => {
        if(v.srcObject) v.srcObject.getTracks().forEach(t=>t.stop());
    });
}

/* --- FINAL SCORING --- */
function calcRisk() {
    // Simple mock logic for prototype
    // In real app, this would use a weighted ML classifier
    let risk = 0;
    if(APP.data.voiceJitter > 2) risk += 20;
    if(APP.data.tremor.rightHz > 3 && APP.data.tremor.rightHz < 7) risk += 30; // PD typical range
    if(APP.data.taps.right < 30) risk += 15;
    if(APP.data.gaitScore < 80) risk += 15;
    
    document.getElementById('d-score').innerText = risk + "%";
    document.getElementById('r-risk').innerText = risk + "%";
}

function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.setFontSize(22); doc.setTextColor(56, 189, 248);
    doc.text("NeuroSynapse-PD Report", 15, 20);
    
    doc.setFontSize(12); doc.setTextColor(0);
    doc.text(`Patient: ${APP.data.name}`, 15, 40);
    doc.text(`Age: ${APP.data.age} | Gender: ${APP.data.gender}`, 15, 48);
    doc.text(`Contact: ${APP.data.contact}`, 15, 56);
    
    doc.setDrawColor(200); doc.line(15, 65, 195, 65);
    
    doc.text("Screening Results:", 15, 80);
    let y = 90;
    const addLine = (txt) => { doc.text(txt, 20, y); y+=10; };
    
    addLine(`Tremor (Right): ${APP.data.tremor.rightHz} Hz / ${APP.data.tremor.rightAmp} amp`);
    addLine(`Tremor (Left): ${APP.data.tremor.leftHz} Hz / ${APP.data.tremor.leftAmp} amp`);
    addLine(`Voice Jitter: ${APP.data.voiceJitter}%`);
    addLine(`Tapping Speed: R ${APP.data.taps.right} / L ${APP.data.taps.left}`);
    addLine(`Gait Score: ${APP.data.gaitScore}/100`);
    
    doc.setTextColor(248, 113, 113);
    doc.text(`CALCULATED RISK: ${document.getElementById('r-risk').innerText}`, 15, y+10);
    
    doc.save("NeuroSynapse_Report.pdf");
}
</script>
</body>
</html>
