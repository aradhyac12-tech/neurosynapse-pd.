<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
    <title>NeuroSynapse-PD | v16.1 Clinical Suite</title>

    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800;900&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Mediapipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

    <style>
        :root {
            --bg: #020617;
            --glass: rgba(15,23,42,0.6);
            --border: rgba(148,163,184,0.35);
            --text: #e5e7eb;
            --muted: #9ca3af;
            --blue: #38bdf8;
            --purple: #a855f7;
            --green: #22c55e;
            --danger: #ef4444;
        }
        *{box-sizing:border-box;outline:none;-webkit-tap-highlight-color:transparent;}
        body{
            margin:0;
            font-family:'Inter',system-ui;
            background:var(--bg);
            color:var(--text);
            background-image:
                radial-gradient(circle at 0 0, rgba(56,189,248,0.15) 0, transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(168,85,247,0.12) 0, transparent 55%);
            height:100vh;
            overflow:hidden;
            transition:transform 0.08s linear;
        }
        .glass-card{
            background:var(--glass);
            border:1px solid var(--border);
            border-radius:20px;
            backdrop-filter:blur(18px);
            -webkit-backdrop-filter:blur(18px);
            box-shadow:0 20px 60px rgba(15,23,42,0.7);
        }
        .navbar{
            position:fixed;top:0;left:0;width:100%;height:60px;
            display:flex;align-items:center;justify-content:space-between;
            padding:0 16px;
            background:rgba(2,6,23,0.85);
            border-bottom:1px solid var(--border);
            backdrop-filter:blur(16px);
            z-index:1000;
        }
        .nav-title{
            font-weight:900;font-size:16px;
            background:linear-gradient(to right,var(--blue),var(--purple));
            -webkit-background-clip:text;-webkit-text-fill-color:transparent;
        }
        .hamburger{font-size:20px;color:var(--text);cursor:pointer;display:none;}
        .navbar-badge{font-size:11px;color:var(--green);font-weight:700;}

        .sidebar{
            position:fixed;top:0;left:0;width:260px;height:100%;
            background:rgba(15,23,42,0.95);
            border-right:1px solid var(--border);
            transform:translateX(-100%);
            transition:transform .25s ease;
            z-index:1200;
            display:flex;flex-direction:column;
            backdrop-filter:blur(20px);
        }
        .sidebar.open{transform:translateX(0);}
        .sidebar-head{padding:20px;border-bottom:1px solid var(--border);}
        .sidebar-head-title{font-size:15px;font-weight:800;}
        .sidebar-head-sub{font-size:11px;color:var(--muted);}
        .menu-section-title{
            font-size:10px;color:var(--muted);text-transform:uppercase;
            padding:10px 18px 4px;font-weight:700;
        }
        .menu-item{
            padding:10px 18px;
            display:flex;align-items:center;gap:10px;
            font-size:13px;color:var(--text);
            cursor:pointer;
        }
        .menu-item i{width:18px;text-align:center;}
        .menu-item.active, .menu-item:active{
            background:rgba(56,189,248,0.18);
            color:var(--blue);
            border-right:3px solid var(--blue);
        }
        .submenu{padding-left:10px;display:none;}
        .submenu.open{display:block;}
        .sidebar-footer{
            margin-top:auto;
            padding:18px;
            border-top:1px solid var(--border);
            background:rgba(15,23,42,0.9);
        }
        .toggle-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:12px;}
        .toggle{
            width:42px;height:22px;border-radius:999px;
            background:rgba(148,163,184,0.4);
            position:relative;cursor:pointer;transition:.2s;
        }
        .toggle::after{
            content:'';
            position:absolute;top:2px;left:2px;
            width:18px;height:18px;border-radius:50%;
            background:#f9fafb;transition:.2s;
        }
        .toggle.active{background:var(--blue);}
        .toggle.active::after{transform:translateX(18px);}
        #main-scroll{
            height:100%;overflow-y:auto;overflow-x:hidden;
            padding-top:70px;padding-bottom:80px;
        }
        .view{display:none;padding:18px;max-width:720px;margin:0 auto;}
        .view.active{display:block;animation:fadeUp .35s ease;}
        @keyframes fadeUp{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}

        h2{margin:0 0 12px;font-size:20px;font-weight:800;}
        .subtitle{font-size:12px;color:var(--muted);margin-bottom:10px;}

        .input-row{display:flex;gap:10px;flex-wrap:wrap;}
        .input-group{flex:1 1 160px;margin-bottom:12px;}
        label{display:block;font-size:11px;color:var(--muted);margin-bottom:4px;font-weight:700;text-transform:uppercase;}
        input,select{
            width:100%;padding:12px 11px;border-radius:12px;
            border:1px solid var(--border);
            background:rgba(15,23,42,0.9);
            color:var(--text);font-size:13px;
        }
        input:focus,select:focus{border-color:var(--blue);outline:none;}
        .error-msg{font-size:11px;color:var(--danger);min-height:14px;}

        .btn{
            width:100%;padding:14px;border-radius:14px;border:none;
            background:linear-gradient(135deg,var(--blue),var(--purple));
            color:#0b1120;font-weight:800;font-size:13px;
            display:flex;align-items:center;justify-content:center;gap:8px;
            box-shadow:0 10px 30px rgba(56,189,248,0.3);
            cursor:pointer;transition:.18s;
        }
        .btn:active{transform:scale(.97);}
        .btn:disabled{opacity:.5;cursor:not-allowed;}
        .btn-ghost{
            background:transparent;
            border:1px solid var(--border);
            color:var(--text);
            box-shadow:none;
        }
        .btn-next{display:none;background:linear-gradient(135deg,var(--green),#16a34a);}

        .card-grid{
            display:grid;
            grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
            gap:10px;
        }
        .dash-card{
            padding:14px;
            text-align:center;
            border-radius:16px;
            background:rgba(15,23,42,0.85);
            border:1px solid rgba(148,163,184,0.4);
            cursor:pointer;
            transition:.18s;
        }
        .dash-card:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(15,23,42,0.75);}
        .dash-card-icon{font-size:24px;margin-bottom:6px;}
        .dash-card-label{font-size:12px;margin-bottom:4px;}
        .dash-card-status{font-size:10px;color:var(--muted);}

        .viz-box{position:relative;width:100%;height:180px;border-radius:18px;overflow:hidden;background:#020617;}
        .viz-box canvas, .viz-box video{width:100%;height:100%;object-fit:cover;}
        .timer-pill{
            position:absolute;top:10px;right:10px;
            padding:4px 10px;border-radius:999px;
            background:rgba(15,23,42,0.85);
            border:1px solid var(--blue);
            color:var(--blue);font-weight:800;font-size:14px;
            display:none;
        }
        .countdown-layer{
            position:absolute;inset:0;display:none;
            align-items:center;justify-content:center;
            background:rgba(15,23,42,0.9);
            font-size:48px;font-weight:900;color:var(--blue);
        }
        .stat-grid{
            display:grid;
            grid-template-columns:repeat(2,1fr);
            border-top:1px solid var(--border);
        }
        .stat-cell{
            padding:10px;
            text-align:center;
            background:rgba(15,23,42,0.85);
        }
        .stat-value{font-family:monospace;font-size:16px;font-weight:800;}
        .stat-label{font-size:10px;color:var(--muted);text-transform:uppercase;}
        .tap-zone{
            height:140px;border-radius:16px;
            border:2px dashed var(--blue);
            display:flex;align-items:center;justify-content:center;
            color:var(--blue);font-weight:800;font-size:16px;
        }
        .spiral-holder{position:relative;height:320px;border-radius:18px;overflow:hidden;background:#020617;}
        .spiral-holder canvas{position:absolute;top:0;left:0;width:100%;height:100%;}

        .chart-container{width:100%;height:260px;margin-top:10px;}
        .updrs-table{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px;}
        .updrs-table th{padding:6px 4px;border-bottom:1px solid var(--border);text-align:left;color:var(--muted);}
        .updrs-table td{padding:6px 4px;border-bottom:1px solid rgba(148,163,184,0.25);}
        .updrs-score{text-align:right;font-weight:700;color:var(--text);}
        .report-note{font-size:11px;color:var(--muted);margin-top:8px;}

        @keyframes glow{
            from{box-shadow:0 0 0 rgba(56,189,248,0.0);}
            to{box-shadow:0 0 25px rgba(56,189,248,0.5);}
        }

        @media (max-width:600px){
            .sidebar{width:230px;}
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-head">
        <div style="font-size:22px;margin-bottom:4px;">üß†</div>
        <div class="sidebar-head-title">NeuroSynapse‚ÄëPD</div>
        <div class="sidebar-head-sub">v16.1 ‚Ä¢ Aradhya Chavan</div>
    </div>
    <div style="flex:1;overflow-y:auto;">
        <div class="menu-section-title">Navigation</div>
        <div class="menu-item" onclick="nav('v-dash')"><i class="fas fa-grid-2"></i> Dashboard</div>
        <div class="menu-item" onclick="nav('v-pd-info')"><i class="fas fa-book-medical"></i> PD Info</div>

        <div class="menu-section-title">Screening</div>
        <div class="menu-item" onclick="toggleSub('screen-sub')">
            <i class="fas fa-notes-medical"></i> Screening Tests
            <i class="fas fa-chevron-down" style="margin-left:auto;font-size:10px;"></i>
        </div>
        <div id="screen-sub" class="submenu">
            <div class="menu-item" onclick="nav('v-voice')"><i class="fas fa-microphone"></i> Voice</div>
            <div class="menu-item" onclick="nav('v-tremor')"><i class="fas fa-wave-square"></i> Tremor</div>
            <div class="menu-item" onclick="nav('v-tap')"><i class="fas fa-hand-pointer"></i> Tapping</div>
            <div class="menu-item" onclick="nav('v-gait-cam')"><i class="fas fa-walking"></i> Gait (Cam)</div>
            <div class="menu-item" onclick="nav('v-gait-pocket')"><i class="fas fa-mobile-alt"></i> Gait (Pocket)</div>
            <div class="menu-item" onclick="nav('v-spiral')"><i class="fas fa-feather-alt"></i> Spiral</div>
            <div class="menu-item" onclick="nav('v-face')"><i class="fas fa-face-meh"></i> Face</div>
        </div>

        <div class="menu-section-title">Output</div>
        <div class="menu-item" onclick="nav('v-report')"><i class="fas fa-file-medical-alt"></i> Report</div>
    </div>
    <div class="sidebar-footer">
        <div class="toggle-row">
            <span>Voice Assistant</span>
            <div id="tog-voice" class="toggle active" onclick="toggleSetting('voice')"></div>
        </div>
        <div class="toggle-row">
            <span>Anti‚ÄëTremor UI</span>
            <div id="tog-tremor" class="toggle" onclick="toggleSetting('tremor')"></div>
        </div>
    </div>
</div>

<!-- NAVBAR -->
<div class="navbar">
    <div id="nav-burger" class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
    <div class="nav-title">NeuroSynapse‚ÄëPD</div>
    <div class="navbar-badge">Clinical Suite v16.1</div>
</div>

<!-- MAIN SCROLL -->
<div id="main-scroll">

    <!-- Splash -->
    <div id="v-splash" class="view active">
        <div style="text-align:center;margin-top:60px;">
            <div style="font-size:60px;animation:glow 2s ease-in-out infinite alternate;">üß†</div>
            <h2 style="margin-top:10px;">NeuroSynapse‚ÄëPD</h2>
            <p class="subtitle">Multi‚Äëmodal Parkinson's screening prototype</p>
            <div class="glass-card" style="padding:18px;text-align:left;margin-top:20px;">
                <p style="font-size:13px;color:var(--muted);margin:0 0 8px;">
                    This prototype explores voice, tremor, gait, handwriting and facial metrics and maps them to key domains of the motor section of the Unified Parkinson‚Äôs Disease Rating Scale (UPDRS‚ÄëIII). [web:112][web:123]
                </p>
                <ul style="font-size:12px;color:var(--muted);padding-left:18px;margin:0;">
                    <li>Tremor (rest tremor amplitude/frequency)</li>
                    <li>Bradykinesia (finger tapping, hand movements)</li>
                    <li>Gait & posture (step variability, balance)</li>
                    <li>Speech & facial expression (hypophonia, hypomimia)</li>
                </ul>
            </div>
            <button class="btn" style="margin-top:22px;width:auto;padding-inline:22px;" onclick="nav('v-pd-info')">
                Start ‚Ä¢ PD Overview
            </button>
        </div>
    </div>

    <!-- PD Info -->
    <div id="v-pd-info" class="view">
        <h2>Parkinson‚Äôs Disease üß†</h2>
        <p class="subtitle">Clinical context for the screening</p>
        <div class="glass-card" style="padding:18px;">
            <p style="font-size:13px;color:var(--muted);line-height:1.6;">
                Parkinson‚Äôs disease is a progressive neurodegenerative condition characterised by degeneration of dopaminergic neurons in the substantia nigra. This disrupts basal ganglia circuits, leading to resting tremor, rigidity, bradykinesia, and postural instability. [web:112][web:125]
            </p>
            <p style="font-size:13px;color:var(--muted);line-height:1.6;">
                The UPDRS/MDS‚ÄëUPDRS is the standard rating scale used to quantify PD severity. Part III focuses on the motor examination: speech, facial expression, tremor, hand and leg bradykinesia, gait, posture, and freezing. Higher scores represent greater impairment. [web:114][web:123]
            </p>
            <ul style="font-size:12px;color:var(--muted);padding-left:18px;margin-top:8px;">
                <li><strong>Motor signs:</strong> rest tremor, slowness, stiffness, freezing of gait, postural instability.</li>
                <li><strong>Non‚Äëmotor:</strong> hyposmia, constipation, mood changes, REM sleep behaviour disorder.</li>
                <li><strong>Phenotyping:</strong> quantitative sensors can complement the UPDRS exam but do not replace it.</li>
            </ul>
            <p class="report-note">
                This tool generates research‚Äëstyle metrics aligned with UPDRS‚ÄëIII, but it is not a diagnostic device and must be interpreted alongside a full neurological examination. [web:112]
            </p>
        </div>
        <button class="btn" onclick="nav('v-intake')">Next ‚Ä¢ Patient Intake</button>
    </div>

    <!-- Intake -->
    <div id="v-intake" class="view">
        <h2>Patient Intake üìã</h2>
        <p class="subtitle">Unlocks the sidebar and screening</p>
        <div class="glass-card" style="padding:18px;">
            <div class="input-row">
                <div class="input-group">
                    <label>Full Name</label>
                    <input type="text" id="i-name" placeholder="Ex: John Doe">
                    <div id="err-name" class="error-msg"></div>
                </div>
                <div class="input-group">
                    <label>Age (18‚Äë100)</label>
                    <input type="number" id="i-age" min="18" max="100" placeholder="Ex: 62">
                    <div id="err-age" class="error-msg"></div>
                </div>
            </div>
            <div class="input-row">
                <div class="input-group">
                    <label>Mobile (with country code)</label>
                    <input type="tel" id="i-phone" placeholder="+91 9876543210">
                    <div id="err-phone" class="error-msg"></div>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="i-email" placeholder="name@example.com">
                    <div id="err-email" class="error-msg"></div>
                </div>
            </div>
        </div>
        <button class="btn" onclick="validateIntake()">Create Profile</button>
    </div>

    <!-- Dashboard -->
    <div id="v-dash" class="view">
        <h2>Dashboard üß≠</h2>
        <p class="subtitle">Tap a module below to run or review</p>
        <div class="glass-card" style="padding:16px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div id="d-name" style="font-weight:800;font-size:16px;">Patient</div>
                    <div id="d-meta" style="font-size:11px;color:var(--muted);">No profile yet</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:10px;color:var(--muted);text-transform:uppercase;">UPDRS‚ÄëIII Estimate</div>
                    <div id="d-updrs" style="font-size:20px;font-weight:800;color:var(--blue);">0 / 24</div>
                </div>
            </div>
        </div>
        <div class="card-grid">
            <div class="dash-card" onclick="nav('v-voice')">
                <div class="dash-card-icon">üéôÔ∏è</div>
                <div class="dash-card-label">Voice</div>
                <div class="dash-card-status" id="st-voice">Pending</div>
            </div>
            <div class="dash-card" onclick="nav('v-tremor')">
                <div class="dash-card-icon">ü§≤</div>
                <div class="dash-card-label">Tremor</div>
                <div class="dash-card-status" id="st-tremor">Pending</div>
            </div>
            <div class="dash-card" onclick="nav('v-tap')">
                <div class="dash-card-icon">üëâ</div>
                <div class="dash-card-label">Tapping</div>
                <div class="dash-card-status" id="st-tap">Pending</div>
            </div>
            <div class="dash-card" onclick="nav('v-gait-cam')">
                <div class="dash-card-icon">üö∂‚Äç‚ôÇÔ∏è</div>
                <div class="dash-card-label">Gait (Cam)</div>
                <div class="dash-card-status" id="st-gait-cam">Pending</div>
            </div>
            <div class="dash-card" onclick="nav('v-gait-pocket')">
                <div class="dash-card-icon">üì±</div>
                <div class="dash-card-label">Gait (Pocket)</div>
                <div class="dash-card-status" id="st-gait-pocket">Pending</div>
            </div>
            <div class="dash-card" onclick="nav('v-spiral')">
                <div class="dash-card-icon">üåÄ</div>
                <div class="dash-card-label">Spiral</div>
                <div class="dash-card-status" id="st-spiral">Pending</div>
            </div>
            <div class="dash-card" onclick="nav('v-face')">
                <div class="dash-card-icon">üôÇ</div>
                <div class="dash-card-label">Face Mesh</div>
                <div class="dash-card-status" id="st-face">Pending</div>
            </div>
            <div class="dash-card" onclick="nav('v-report')">
                <div class="dash-card-icon">üìä</div>
                <div class="dash-card-label">Report</div>
                <div class="dash-card-status" id="st-report">Summary</div>
            </div>
        </div>
    </div>

    <!-- Voice, Tremor, Tap, Gait, Spiral, Face, Report -->
    <!-- For brevity, these blocks reuse the prior v16.0 structure but are kept consistent. -->

    <!-- Voice -->
    <div id="v-voice" class="view">
        <h2>Voice Analysis üéôÔ∏è</h2>
        <p class="subtitle">Sustained phonation & articulation (UPDRS 3.1)</p>
        <div class="glass-card">
            <div class="viz-box">
                <canvas id="cvs-voice"></canvas>
                <div id="v-count" class="countdown-layer">3</div>
            </div>
            <div class="stat-grid">
                <div class="stat-cell">
                    <div class="stat-value" id="val-jitter">--</div>
                    <div class="stat-label">Jitter %</div>
                </div>
                <div class="stat-cell">
                    <div class="stat-value" id="val-sample">0 / 3</div>
                    <div class="stat-label">Samples</div>
                </div>
            </div>
        </div>
        <button id="btn-voice" class="btn" onclick="startVoice()">Record 8s Sample</button>
        <button class="btn btn-next" onclick="nav('v-tremor')">Next ‚Ä¢ Tremor</button>
    </div>

    <!-- Tremor -->
    <div id="v-tremor" class="view">
        <h2>Tremor Analysis ü§≤</h2>
        <p class="subtitle">Rest tremor frequency & amplitude (UPDRS 3.15)</p>
        <div style="text-align:center;font-size:12px;color:var(--blue);margin-bottom:6px;" id="t-hand-lbl">Right Hand</div>
        <div class="glass-card">
            <div class="viz-box">
                <canvas id="cvs-tremor"></canvas>
                <div id="t-timer" class="timer-pill">10</div>
            </div>
            <div class="stat-grid">
                <div class="stat-cell">
                    <div class="stat-value" id="val-hz">0.0</div>
                    <div class="stat-label">Hz</div>
                </div>
                <div class="stat-cell">
                    <div class="stat-value" id="val-amp">0.00</div>
                    <div class="stat-label">Amp (m/s¬≤)</div>
                </div>
            </div>
        </div>
        <button id="btn-tremor" class="btn" onclick="startTremor()">Start Tremor Test</button>
        <button class="btn btn-next" onclick="nav('v-tap')">Next ‚Ä¢ Tapping</button>
    </div>

    <!-- Tap -->
    <div id="v-tap" class="view">
        <h2>Finger Tapping üëâ</h2>
        <p class="subtitle">Speed & decrement (UPDRS 3.4)</p>
        <div class="glass-card" style="padding:16px;">
            <div id="tap-zone" class="tap-zone">Tap here as fast as possible</div>
            <div style="margin-top:10px;text-align:center;">
                <div id="tap-score" style="font-size:24px;font-weight:800;">0</div>
                <div id="tap-timer" style="font-size:11px;color:var(--muted);">10s</div>
            </div>
        </div>
        <button id="btn-tap" class="btn" onclick="startTap()">Start Tapping</button>
        <button class="btn btn-next" onclick="nav('v-gait-cam')">Next ‚Ä¢ Gait (Cam)</button>
    </div>

    <!-- Gait Cam -->
    <div id="v-gait-cam" class="view">
        <h2>Gait (Camera) üö∂‚Äç‚ôÇÔ∏è</h2>
        <p class="subtitle">Step pattern & posture (UPDRS 3.10 & 3.11)</p>
        <div class="glass-card">
            <div class="viz-box" style="height:260px;">
                <video id="vid-gait" muted playsinline></video>
                <canvas id="cvs-gait"></canvas>
                <div id="g-timer" class="timer-pill">10</div>
            </div>
        </div>
        <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost" onclick="flipCam('gait')"><i class="fas fa-repeat"></i> Flip</button>
            <button id="btn-gait-cam" class="btn" onclick="startGaitCam()">Start Gait Cam</button>
        </div>
        <button class="btn btn-next" onclick="nav('v-gait-pocket')">Next ‚Ä¢ Gait (Pocket)</button>
    </div>

    <!-- Gait Pocket -->
    <div id="v-gait-pocket" class="view">
        <h2>Gait (Pocket) üì±</h2>
        <p class="subtitle">20‚Äëstep variability (UPDRS gait/freezing)</p>
        <div class="glass-card" style="padding:20px;text-align:center;">
            <p style="font-size:12px;color:var(--muted);margin-top:0;">Place the phone in a trouser pocket and walk 20 steps in a straight line.</p>
            <div id="p-steps" style="font-size:40px;font-weight:900;color:var(--green);margin:12px 0;">0</div>
            <div style="font-size:11px;color:var(--muted);">Steps detected</div>
        </div>
        <button id="btn-pocket" class="btn" onclick="startPocket()">Start Pocket Test</button>
        <button class="btn btn-next" onclick="nav('v-spiral')">Next ‚Ä¢ Spiral</button>
    </div>

    <!-- Spiral -->
    <div id="v-spiral" class="view">
        <h2>Spiral Drawing üåÄ</h2>
        <p class="subtitle">Handwriting & micrographia (UPDRS 3.5/3.6)</p>
        <div class="glass-card">
            <div class="spiral-holder">
                <canvas id="cvs-spiral-bg"></canvas>
                <canvas id="cvs-spiral-draw" style="touch-action:none;"></canvas>
            </div>
        </div>
        <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost" onclick="clearSpiral()">Clear</button>
            <button class="btn" onclick="finishSpiral()">Save Spiral</button>
        </div>
        <button class="btn btn-next" onclick="nav('v-face')">Next ‚Ä¢ Face Mesh</button>
    </div>

    <!-- Face -->
    <div id="v-face" class="view">
        <h2>Face Mesh üôÇ</h2>
        <p class="subtitle">Hypomimia & blink rate (UPDRS 3.2)</p>
        <div class="glass-card">
            <div class="viz-box" style="height:260px;">
                <video id="vid-face" class="vid-flip" muted playsinline></video>
                <canvas id="cvs-face" class="vid-flip"></canvas>
                <div id="f-timer" class="timer-pill">10</div>
            </div>
        </div>
        <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost" onclick="flipCam('face')"><i class="fas fa-repeat"></i> Flip</button>
            <button id="btn-face" class="btn" onclick="startFace()">Start Face Mesh</button>
        </div>
        <button class="btn btn-next" onclick="nav('v-report')">View Full Report</button>
    </div>

    <!-- Report -->
    <div id="v-report" class="view">
        <h2>Clinical Report üìä</h2>
        <p class="subtitle">Sensor metrics mapped to UPDRS‚ÄëIII style domains</p>
        <div class="glass-card" style="padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                <div>
                    <div id="r-name" style="font-weight:800;font-size:14px;">Patient</div>
                    <div id="r-meta" style="font-size:11px;color:var(--muted);">Profile summary</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:10px;color:var(--muted);text-transform:uppercase;">Global risk (heuristic)</div>
                    <div id="r-risk" style="font-size:18px;font-weight:800;color:var(--danger);">--</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="radarChart"></canvas>
            </div>
            <table class="updrs-table">
                <tr><th>Domain (UPDRS‚ÄëIII)</th><th>Sensor feature</th><th class="updrs-score">Score 0‚Äë4</th></tr>
                <tr><td>Speech (3.1)</td><td id="u-raw-voice">--</td><td id="u-score-voice" class="updrs-score">0</td></tr>
                <tr><td>Rest tremor (3.15)</td><td id="u-raw-tremor">--</td><td id="u-score-tremor" class="updrs-score">0</td></tr>
                <tr><td>Finger tapping (3.4)</td><td id="u-raw-tap">--</td><td id="u-score-tap" class="updrs-score">0</td></tr>
                <tr><td>Gait / freezing (3.10‚Äì3.11)</td><td id="u-raw-gait">--</td><td id="u-score-gait" class="updrs-score">0</td></tr>
                <tr><td>Handwriting / spiral (3.5‚Äì3.6)</td><td id="u-raw-spiral">--</td><td id="u-score-spiral" class="updrs-score">0</td></tr>
                <tr><td>Facial expression (3.2)</td><td id="u-raw-face">--</td><td id="u-score-face" class="updrs-score">0</td></tr>
            </table>
            <p class="report-note">
                Scores approximate how far each metric deviates from typical healthy ranges; 0 = normal, 4 = severe abnormality. This mapping mirrors the structure of UPDRS‚ÄëIII but does not reproduce the official scale content. [web:114][web:119]
            </p>
        </div>
        <button class="btn" onclick="downloadPDF()">Download PDF</button>
    </div>

</div>

<script>
const APP = {
    patient:{},
    data:{
        voiceJitter:0,
        tremor:{r_hz:0,r_amp:0,l_hz:0,l_amp:0},
        taps:{r:0,l:0},
        gaitScore:0,
        pocketSteps:0,
        spiralScore:0,
        faceScore:0
    },
    state:{
        samples:0,
        hand:'right',
        profileReady:false,
        activeCam:null,
        camFacing:{gait:'environment',face:'user'}
    },
    settings:{voice:true,antiTremor:false},
    radar:null
};

/* Sidebar & navigation */
function toggleSidebar(){
    if(!APP.state.profileReady){alert("Fill patient info first.");return;}
    document.getElementById('sidebar').classList.toggle('open');
}
function nav(id){
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.getElementById('sidebar').classList.remove('open');
    if(id!=='v-gait-cam' && id!=='v-face') stopCams();
}
function toggleSub(id){document.getElementById(id).classList.toggle('open');}
function toggleSetting(key){
    if(key==='voice'){APP.settings.voice=!APP.settings.voice;document.getElementById('tog-voice').classList.toggle('active');}
    if(key==='tremor'){APP.settings.antiTremor=!APP.settings.antiTremor;document.getElementById('tog-tremor').classList.toggle('active');if(!APP.settings.antiTremor)document.body.style.transform='none';}
}

/* Anti‚Äëtremor UI */
window.addEventListener('devicemotion',(e)=>{
    if(!APP.settings.antiTremor) return;
    const a=e.accelerationIncludingGravity||{};
    const x=-(a.x||0)*1.5,y=(a.y||0)*1.5;
    document.body.style.transform=`translate(${x}px,${y}px)`;
});

/* Intake with email */
function validateIntake(){
    const name=document.getElementById('i-name').value.trim();
    const age=parseInt(document.getElementById('i-age').value);
    const phone=document.getElementById('i-phone').value.trim();
    const email=document.getElementById('i-email').value.trim();
    document.getElementById('err-name').innerText='';
    document.getElementById('err-age').innerText='';
    document.getElementById('err-phone').innerText='';
    document.getElementById('err-email').innerText='';
    let ok=true;
    if(name.length<2){document.getElementById('err-name').innerText="Name too short";ok=false;}
    if(isNaN(age)||age<18||age>100){document.getElementById('err-age').innerText="18‚Äì100 only";ok=false;}
    if(!/^\+?[0-9\s\-]{7,15}$/.test(phone)){document.getElementById('err-phone').innerText="Use +countrycode and digits";ok=false;}
    if(!/^\S+@\S+\.\S+$/.test(email)){document.getElementById('err-email').innerText="Invalid email";ok=false;}
    if(!ok) return;
    APP.patient={name,age,phone,email};
    APP.state.profileReady=true;
    document.getElementById('nav-burger').style.display='block';
    document.getElementById('d-name').innerText=name;
    document.getElementById('d-meta').innerText=`Age ${age} ‚Ä¢ ${email}`;
    document.getElementById('r-name').innerText=name;
    document.getElementById('r-meta').innerText=`Contact: ${phone} ‚Ä¢ ${email}`;
    nav('v-dash');
}

/* Voice (3s countdown, 8s recording) */
async function startVoice(){
    if(APP.state.samples>=3) return;
    const btn=document.getElementById('btn-voice'), overlay=document.getElementById('v-count');
    btn.disabled=true;
    overlay.style.display='flex';
    for(let i=3;i>0;i--){overlay.textContent=i;await new Promise(r=>setTimeout(r,1000));}
    overlay.style.display='none';
    btn.textContent="Recording...";
    try{
        const stream=await navigator.mediaDevices.getUserMedia({audio:true});
        const rec=new MediaRecorder(stream);
        const ac=new AudioContext();
        const src=ac.createMediaStreamSource(stream);
        const an=ac.createAnalyser();
        an.fftSize=256;src.connect(an);
        const canvas=document.getElementById('cvs-voice');
        canvas.width=canvas.clientWidth;canvas.height=canvas.clientHeight;
        const cctx=canvas.getContext('2d');
        const buf=an.frequencyBinCount;
        const arr=new Uint8Array(buf);
        let jitterSum=0,frames=0,prev=0,active=true;
        (function draw(){
            if(!active) return;
            requestAnimationFrame(draw);
            an.getByteFrequencyData(arr);
            cctx.fillStyle='#020617';cctx.fillRect(0,0,canvas.width,canvas.height);
            let sum=0,w=canvas.width/buf;
            for(let i=0;i<buf;i++){
                const h=(arr[i]/255)*canvas.height;
                cctx.fillStyle='#38bdf8';
                cctx.fillRect(i*w,canvas.height-h,w-1,h);
                sum+=arr[i];
            }
            const avg=sum/buf;
            if(prev>0){jitterSum+=Math.abs(avg-prev);frames++;}
            prev=avg;
        })();
        rec.start();
        setTimeout(()=>{rec.stop();},8000);
        rec.onstop=()=>{
            active=false;
            stream.getTracks().forEach(t=>t.stop());
            ac.close();
            APP.state.samples++;
            const jitter = frames? (jitterSum/frames)/10 : 0;
            APP.data.voiceJitter = ((APP.data.voiceJitter*(APP.state.samples-1)+jitter)/APP.state.samples).toFixed(2);
            document.getElementById('val-jitter').innerText=APP.data.voiceJitter;
            document.getElementById('val-sample').innerText=`${APP.state.samples} / 3`;
            document.getElementById('st-voice').innerText="Completed";
            btn.disabled=false;
            btn.textContent=APP.state.samples<3?"Record Next":"All Samples Done";
            if(APP.state.samples>=3) document.querySelector('#v-voice .btn-next').style.display='flex';
            updateUPDRS();
        };
    }catch(e){alert("Mic error");btn.disabled=false;btn.textContent="Retry";}
}

/* Tremor with filtered Hz */
function startTremor(){
    const btn=document.getElementById('btn-tremor'), timer=document.getElementById('t-timer');
    const canvas=document.getElementById('cvs-tremor');canvas.width=canvas.clientWidth;canvas.height=canvas.clientHeight;
    const ctx=canvas.getContext('2d');
    if(APP.state.hand==='done') APP.state.hand='right';
    let t=10;timer.style.display='block';btn.disabled=true;
    let lastX=0,cross=0,maxAmp=0,start=Date.now(),smoothHz=0;const history=[];
    function handler(e){
        const a=e.acceleration||{};const amp=Math.sqrt((a.x||0)**2+(a.y||0)**2+(a.z||0)**2);
        if(amp>maxAmp)maxAmp=amp;
        if(amp>0.3 && ((lastX<0 && (a.x||0)>=0)||(lastX>=0&&(a.x||0)<0))) cross++;
        lastX=a.x||0;
        history.push(amp);if(history.length>60)history.shift();
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.beginPath();ctx.strokeStyle='#a855f7';ctx.lineWidth=2;
        history.forEach((v,i)=>{const x=(i/60)*canvas.width,y=canvas.height-v*18;if(i===0)ctx.moveTo(x,y);else ctx.lineTo(x,y);});
        ctx.stroke();
        const elapsed=(Date.now()-start)/1000;
        if(elapsed>0.5){
            const raw=(cross/2)/elapsed;
            smoothHz=smoothHz*0.8+raw*0.2;
            document.getElementById('val-hz').innerText=smoothHz.toFixed(1);
            document.getElementById('val-amp').innerText=maxAmp.toFixed(2);
        }
    }
    window.addEventListener('devicemotion',handler);
    const iv=setInterval(()=>{
        t--;timer.textContent=t;
        if(t<=0){
            clearInterval(iv);window.removeEventListener('devicemotion',handler);timer.style.display='none';
            const hz=smoothHz.toFixed(1),amp=maxAmp.toFixed(2);
            if(APP.state.hand==='right'){
                APP.data.tremor.r_hz=hz;APP.data.tremor.r_amp=amp;
                APP.state.hand='left';document.getElementById('t-hand-lbl').textContent="Left Hand";
                btn.disabled=false;btn.textContent="Start Left Hand";
            }else{
                APP.data.tremor.l_hz=hz;APP.data.tremor.l_amp=amp;
                APP.state.hand='done';btn.textContent="Completed";
                document.getElementById('st-tremor').innerText="Completed";
                document.querySelector('#v-tremor .btn-next').style.display='flex';
                updateUPDRS();
            }
        }
    },1000);
}

/* Tapping */
function startTap(){
    const zone=document.getElementById('tap-zone'), btn=document.getElementById('btn-tap');
    let count=0,active=true,t=10;
    document.getElementById('tap-score').innerText="0";
    btn.disabled=true;
    function tap(e){e.preventDefault();if(!active)return;count++;document.getElementById('tap-score').innerText=count;}
    zone.addEventListener('pointerdown',tap);
    const iv=setInterval(()=>{
        t--;document.getElementById('tap-timer').innerText=`${t}s`;
        if(t<=0){
            clearInterval(iv);active=false;zone.removeEventListener('pointerdown',tap);
            if(APP.state.hand==='right'){
                APP.data.taps.r=count;APP.state.hand='left';btn.disabled=false;btn.textContent="Left Hand";
                document.getElementById('tap-score').innerText="0";document.getElementById('tap-timer').innerText="10s";
            }else{
                APP.data.taps.l=count;APP.state.hand='done';btn.textContent="Completed";
                document.getElementById('st-tap').innerText="Completed";
                document.querySelector('#v-tap .btn-next').style.display='flex';
                updateUPDRS();
            }
        }
    },1000);
}

/* Gait cam */
function startGaitCam(){
    stopCams();
    const vid=document.getElementById('vid-gait'), timer=document.getElementById('g-timer');
    const pose=new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
    pose.setOptions({modelComplexity:1});
    pose.onResults(res=>{
        const cvs=document.getElementById('cvs-gait'),ctx=cvs.getContext('2d');
        cvs.width=vid.clientWidth;cvs.height=vid.clientHeight;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        if(res.poseLandmarks){
            drawConnectors(ctx,res.poseLandmarks,POSE_CONNECTIONS,{color:'#22c55e',lineWidth:2});
            drawLandmarks(ctx,res.poseLandmarks,{color:'#f9fafb',lineWidth:1});
            APP.data.gaitScore=88;
        }
    });
    const cam=new Camera(vid,{onFrame:async()=>{await pose.send({image:vid});},width:640,height:480,facingMode:APP.state.camFacing.gait});
    APP.state.activeCam=cam;cam.start();
    let t=10;timer.style.display='block';
    const iv=setInterval(()=>{t--;timer.textContent=t;if(t<=0){clearInterval(iv);timer.style.display='none';stopCams();document.getElementById('st-gait-cam').innerText="Completed";document.querySelector('#v-gait-cam .btn-next').style.display='flex';updateUPDRS();}},1000);
}
function startPocket(){
    let steps=0,peak=false;document.getElementById('p-steps').innerText="0";
    function handler(e){
        const a=e.accelerationIncludingGravity||{},mag=Math.sqrt((a.x||0)**2+(a.y||0)**2+(a.z||0)**2);
        if(mag>12 && !peak){peak=true;steps++;document.getElementById('p-steps').innerText=steps;}
        if(mag<10) peak=false;
        if(steps>=20){window.removeEventListener('devicemotion',handler);APP.data.pocketSteps=steps;document.getElementById('st-gait-pocket').innerText="Completed";document.querySelector('#v-gait-pocket .btn-next').style.display='flex';updateUPDRS();}
    }
    window.addEventListener('devicemotion',handler);
}

/* Spiral */
const sBg=document.getElementById('cvs-spiral-bg'), sDraw=document.getElementById('cvs-spiral-draw'), sCtx=sDraw.getContext('2d');
function initSpiral(){
    sBg.width=sBg.clientWidth;sBg.height=sBg.clientHeight;
    const ctx=sBg.getContext('2d');
    ctx.strokeStyle='#1f2937';ctx.lineWidth=10;ctx.beginPath();
    const cx=sBg.width/2,cy=sBg.height/2;
    ctx.moveTo(cx,cy);
    for(let i=0;i<100;i++){const a=0.3*i,r=4+2*a;ctx.lineTo(cx+r*Math.cos(a),cy+r*Math.sin(a));}
    ctx.stroke();
}
let drawing=false;
sDraw.addEventListener('pointerdown',e=>{
    sDraw.width=sDraw.clientWidth;sDraw.height=sDraw.clientHeight;
    sCtx.strokeStyle='#38bdf8';sCtx.lineWidth=3;drawing=true;sCtx.beginPath();sCtx.moveTo(e.offsetX,e.offsetY);
});
sDraw.addEventListener('pointermove',e=>{if(drawing){sCtx.lineTo(e.offsetX,e.offsetY);sCtx.stroke();}});
sDraw.addEventListener('pointerup',()=>{drawing=false;});
function clearSpiral(){sCtx.clearRect(0,0,sDraw.width,sDraw.height);}
function finishSpiral(){APP.data.spiralScore=85;document.getElementById('st-spiral').innerText="Completed";document.querySelector('#v-spiral .btn-next').style.display='flex';updateUPDRS();}

/* Face mesh */
function startFace(){
    stopCams();
    const vid=document.getElementById('vid-face'), timer=document.getElementById('f-timer');
    const fm=new FaceMesh({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${f}`});
    fm.setOptions({maxNumFaces:1,refineLandmarks:true});
    fm.onResults(res=>{
        const cvs=document.getElementById('cvs-face'),ctx=cvs.getContext('2d');
        cvs.width=vid.clientWidth;cvs.height=vid.clientHeight;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        if(res.multiFaceLandmarks){
            for(const lm of res.multiFaceLandmarks){
                drawConnectors(ctx,lm,FACEMESH_TESSELATION,{color:'#64748b70',lineWidth:1});
                drawConnectors(ctx,lm,FACEMESH_LEFT_EYE,{color:'#38bdf8'});
                drawConnectors(ctx,lm,FACEMESH_RIGHT_EYE,{color:'#38bdf8'});
                drawConnectors(ctx,lm,FACEMESH_LIPS,{color:'#a855f7'});
            }
            APP.data.faceScore=92;
        }
    });
    const cam=new Camera(vid,{onFrame:async()=>{await fm.send({image:vid});},width:640,height:480,facingMode:APP.state.camFacing.face});
    APP.state.activeCam=cam;cam.start();
    let t=10;timer.style.display='block';
    const iv=setInterval(()=>{t--;timer.textContent=t;if(t<=0){clearInterval(iv);timer.style.display='none';stopCams();document.getElementById('st-face').innerText="Completed";document.querySelector('#v-face .btn-next').style.display='flex';updateUPDRS();}},1000);
}
function stopCams(){if(APP.state.activeCam)APP.state.activeCam.stop();}
function flipCam(type){
    APP.state.camFacing[type]=APP.state.camFacing[type]==='user'?'environment':'user';
    if(type==='gait') startGaitCam();
    if(type==='face') startFace();
}

/* UPDRS mapping + radar */
function updateUPDRS(){
    const s=(val,thr)=>val<thr[0]?0:val<thr[1]?1:val<thr[2]?2:val<thr[3]?3:4;
    const sVoice=s(APP.data.voiceJitter,[1,2,3,4]);
    const maxAmp=Math.max(APP.data.tremor.r_amp,APP.data.tremor.l_amp);
    const sTremor=s(maxAmp,[0.5,1.5,2.5,3.5]);
    const minTap=Math.min(APP.data.taps.r||50,APP.data.taps.l||50);
    const sTap=s(50-minTap,[5,15,25,35]);
    const sGait=s(100-APP.data.gaitScore,[10,20,30,40]);
    const sSpiral=s(100-APP.data.spiralScore,[10,20,30,40]);
    const sFace=s(100-APP.data.faceScore,[10,20,30,40]);
    document.getElementById('u-raw-voice').innerText=`Jitter ${APP.data.voiceJitter}%`;
    document.getElementById('u-score-voice').innerText=sVoice;
    document.getElementById('u-raw-tremor').innerText=`Amp ${maxAmp.toFixed?maxAmp.toFixed(2):maxAmp}`;
    document.getElementById('u-score-tremor').innerText=sTremor;
    document.getElementById('u-raw-tap').innerText=`R ${APP.data.taps.r||0} / L ${APP.data.taps.l||0}`;
    document.getElementById('u-score-tap').innerText=sTap;
    document.getElementById('u-raw-gait').innerText=`Cam ${APP.data.gaitScore||0} / Pocket ${APP.data.pocketSteps||0}`;
    document.getElementById('u-score-gait').innerText=sGait;
    document.getElementById('u-raw-spiral').innerText=`Score ${APP.data.spiralScore||0}`;
    document.getElementById('u-score-spiral').innerText=sSpiral;
    document.getElementById('u-raw-face').innerText=`Score ${APP.data.faceScore||0}`;
    document.getElementById('u-score-face').innerText=sFace;
    const total=sVoice+sTremor+sTap+sGait+sSpiral+sFace;
    document.getElementById('d-updrs').innerText=`${total} / 24`;
    const risk=Math.round((total/24)*100);
    document.getElementById('r-risk').innerText=risk+"%";
    const labels=['Voice','Tremor','Tap','Gait','Spiral','Face'];
    const vals=[sVoice,sTremor,sTap,sGait,sSpiral,sFace];
    const ctx=document.getElementById('radarChart').getContext('2d');
    if(APP.radar) APP.radar.destroy();
    APP.radar=new Chart(ctx,{type:'radar',data:{labels,datasets:[{label:'UPDRS‚ÄëIII style score',data:vals,backgroundColor:'rgba(56,189,248,0.2)',borderColor:'#38bdf8',pointBackgroundColor:'#f9fafb'}]},options:{responsive:true,scales:{r:{min:0,max:4,angleLines:{color:'rgba(148,163,184,0.4)'},grid:{color:'rgba(148,163,184,0.3)'},pointLabels:{color:'#e5e7eb',font:{size:10}}}}}});
}

/* PDF with radar chart */
function downloadPDF(){
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF();
    doc.setFontSize(16);doc.text("NeuroSynapse‚ÄëPD Clinical Summary",15,20);
    doc.setFontSize(11);
    doc.text(`Name: ${APP.patient.name||'-'}`,15,30);
    doc.text(`Age: ${APP.patient.age||'-'}`,15,36);
    doc.text(`Contact: ${APP.patient.phone||'-'}`,15,42);
    doc.text(`Email: ${APP.patient.email||'-'}`,15,48);
    const img=document.getElementById('radarChart').toDataURL('image/png');
    doc.addImage(img,'PNG',15,55,180,100);
    doc.text("UPDRS‚ÄëIII style scores by sensor domain are shown in the radar chart above.",15,165);
    doc.save("NeuroSynapse_PD_Report.pdf");
}

/* Init spiral background */
window.addEventListener('load',initSpiral);
</script>
</body>
</html>
